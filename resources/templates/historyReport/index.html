<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <title>履歴レポート</title>
    <link rel="stylesheet" th:href="@{/css/unified-table.css}" />
    <style>
        .history-report-container {
            padding: 10px 15px;
        }
        .filter-section {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .unified-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }
        .unified-table th,
        .unified-table td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: left;
            font-size: 0.9rem;
        }
        .unified-table th {
            background-color: #6c757d;
            color: white;
            font-weight: bold;
        }
        .unified-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .unified-table tbody tr.row-normal {
            background-color: #ffffff !important;
        }

        .unified-table tbody tr.row-warning {
            background-color: #fff3cd !important;
        }

        .unified-table tbody tr.row-error {
            background-color: #f8d7da !important;
        }

        .unified-table tbody tr.row-recovery {
            background-color: #d1ecf1 !important;
        }

        .row-normal {
            background-color: #ffffff !important;
        }
        .row-warning {
            background-color: #fff3cd !important;
        }
        .row-error {
            background-color: #f8d7da !important;
            color: #dc3545;
        }

        .row-recovery {
            background-color: #d1ecf1 !important;
            color: #0c5460;
        }

        .filter-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .filter-group {
            min-width: 200px;
            flex: 1;
        }
        .filter-group h6 {
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.95rem;
            font-weight: bold;
        }

        .unified-table th {
            position: relative;
            padding-right: 30px;
            user-select: none;
        }

        .unified-table th.sortable {
            cursor: pointer;
        }

        .unified-table th.sortable:hover {
            background-color: #5a6268;
        }

        .excel-filter-trigger {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
            transition: all 0.2s ease;
        }

        .excel-filter-trigger:hover {
            background: rgba(0,0,0,0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .excel-filter-trigger::after {
            content: '▼';
            font-size: 8px;
            color: #333;
        }

        .excel-filter-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid #e7e7e7;
            padding: 0;
            z-index: 1000;
            min-width: 280px;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .excel-filter-menu.show {
            display: block;
        }

        .excel-filter-header {
            background: linear-gradient(180deg, #f7f7f7 0%, #e7e7e7 100%);
            border-bottom: 1px solid #d0d0d0;
            padding: 8px 12px;
            font-size: 0.85em;
            font-weight: 600;
            color: #333;
        }

        .excel-search-section {
            padding: 10px 12px;
            border-bottom: 1px solid #e7e7e7;
            background: #fafafa;
        }

        .excel-search-box {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #b7b7b7;
            font-size: 0.85em;
            background: white;
        }

        .excel-filter-actions {
            padding: 8px 12px;
            background: #f7f7f7;
            border-bottom: 1px solid #e7e7e7;
            display: flex;
            gap: 8px;
        }

        .excel-action-btn {
            padding: 4px 12px;
            border: 1px solid #b7b7b7;
            background: white;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .excel-action-btn:hover {
            background: #e7e7e7;
        }

        .excel-action-btn.primary {
            background: #4472c4;
            color: white;
            border-color: #4472c4;
        }

        .excel-filter-list {
            max-height: 200px;
            overflow-y: auto;
            background: white;
        }

        .excel-filter-item {
            display: flex;
            align-items: center;
            padding: 4px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 0.85em;
        }

        .excel-filter-item:hover {
            background: #e7f3ff;
        }

        .excel-filter-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .column-visibility-toggle {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #333;
        }

        .column-list {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            padding: 8px;
            background: #f8f9fa;
        }

        .column-item-manager {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            cursor: pointer;
        }

        .column-item-manager:hover {
            background: #e9ecef;
        }

        .column-item-manager.hidden {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .data-type-select.normal-selected {
            background-color: #ffffff;
        }

        .data-type-select.warning-selected {
            background-color: #fff3cd;
            color: #856404;
        }

        .data-type-select.error-selected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .data-type-select.recovery-selected {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .form-select, .form-control {
            font-size: 0.9rem;
            padding: 4px 8px;
        }

        .history-report-container h2 {
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h2>履歴レポート</h2>
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center gap-2">
                    <span style="font-weight: bold; white-space: nowrap;">表示件数:</span>
                    <select id="itemsPerPageSelect" class="form-select" style="width: auto; min-width: 100px;">
                        <option value="25" selected>25件</option>
                        <option value="50">50件</option>
                        <option value="100">100件</option>
                    </select>
                </div>
                <div class="display-count" style="color: #dc3545; font-weight: bold; font-size: 1.1rem;">
                    現条件: <span id="recordCountTop">0</span> 件
                </div>
            </div>
        </div>

        <!-- アクションツールバー -->
        <div class="unified-action-toolbar" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <div class="primary-actions" style="display: flex; gap: 8px;">
                <button type="button" class="btn btn-warning" onclick="showPeriodSelection()" style="background-color: #fd7e14; border-color: #fd7e14; color: white;">
                    ▼期間抽出
                </button>
                <button type="button" class="btn btn-secondary" style="background-color: #6c757d;">
                    ▼条件抽出
                </button>
                <button type="button" class="btn btn-secondary" style="background-color: #6c757d;">
                    条件保存
                </button>
                <button type="button" class="btn btn-outline-info" style="border-color: #17a2b8; color: #17a2b8; background: white;">
                    <i class="fas fa-external-link-alt"></i> エクスポート
                </button>
            </div>
            <div class="secondary-actions" style="display: flex; gap: 8px;">
                <button class="btn btn-outline-secondary btn-sm" onclick="resetAllFilters()">
                    <i class="fas fa-filter-circle-xmark"></i> フィルターリセット
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="showColumnManager()" id="columnManagerBtn">
                    <i class="fas fa-columns"></i> 列表示管理
                    <span class="badge bg-warning ms-1" id="hiddenColumnsBadge" style="display: none;">0</span>
                </button>
            </div>
        </div>

        <div class="unified-filter-panel" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
            <div class="filter-section" style="display: flex; flex-wrap: wrap; gap: 30px; align-items: center;">
                <!-- データ種別 -->
                <div class="filter-group" style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: bold; white-space: nowrap;">◆データ種別：</span>
                    <select id="dataDisplayFilter" class="form-select data-type-select" style="width: auto; min-width: 250px;" onchange="updateTableColoring(); updateSelectColor(this);">
                        <option value="all">全データ表示</option>
                        <option value="normal">正常データ</option>
                        <option value="warning">軽エラーデータ</option>
                        <option value="error">重エラーデータ</option>
                        <option value="recovery">重エラー復旧データ</option>
                    </select>
                </div>

                <!-- 抽出期間 -->
                <div class="filter-group" style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: bold; white-space: nowrap;">◆抽出期間：</span>
                    <div style="border: 1px solid #ced4da; padding: 6px 15px; border-radius: 4px; background: white; min-width: 350px; font-family: monospace; font-size: 0.95rem;" id="extractionPeriodDisplay">
                        YYYY/MM/DD hh:mm ～ YYYY/MM/DD hh:mm
                    </div>
                </div>
            </div>
        </div>

        <!-- データテーブル -->
        <div class="unified-table-container" id="dataTableContainer" style="display: none;">
            <table class="unified-table" id="historyTable">
                <thead>
                    <tr id="tableHeaders">
                        <!-- Headers will be dynamically generated by JavaScript -->
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- Data will be dynamically generated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- データ未選択時のメッセージ -->
        <div id="noDataMessage" class="text-center p-5" style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 20px;">
            <i class="fas fa-info-circle text-muted" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <h5 class="text-muted">データが選択されていません</h5>
            <p class="text-muted">「抽出」ボタンを押して対象期間を選択してください。</p>
        </div>

        <!-- ページネーション -->
        <div class="pagination-controls" id="paginationContainer" style="display: none; justify-content: space-between; align-items: center; margin-top: 15px;">
            <div class="page-info" id="pageInfo">
                1-30 / 1,000件中
            </div>
            <nav aria-label="ページネーション">
                <ul class="pagination pagination-sm" id="pagination">
                </ul>
            </nav>
        </div>

        <!-- 期間選択モーダル -->
        <div class="modal fade" id="periodSelectionModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-calendar-alt text-primary"></i>
                            対象期間選択
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="period-selection">
                            <h6>対象期間</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="periodOption" id="allPeriod" value="all" checked>
                                    <label class="form-check-label" for="allPeriod">全期間</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="periodOption" id="oneYear" value="1year">
                                    <label class="form-check-label" for="oneYear">1年前～</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="periodOption" id="oneMonth" value="1month">
                                    <label class="form-check-label" for="oneMonth">1ヵ月前～</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="periodOption" id="oneWeek" value="1week">
                                    <label class="form-check-label" for="oneWeek">1週間前～</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="periodOption" id="oneDay" value="1day">
                                    <label class="form-check-label" for="oneDay">1日前～</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="periodOption" id="customPeriod" value="custom">
                                    <label class="form-check-label" for="customPeriod">期間指定</label>
                                </div>
                            </div>

                            <div id="customPeriodInputs" style="display: none; margin-top: 15px;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="startDateModal" class="form-label">開始日時</label>
                                        <input type="datetime-local" class="form-control" id="startDateModal">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="endDateModal" class="form-label">終了日時</label>
                                        <input type="datetime-local" class="form-control" id="endDateModal">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                        <button type="button" class="btn btn-primary" onclick="applyPeriodSelection()">適用</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 列表示管理モーダル -->
        <div class="modal fade" id="columnManagerModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-columns text-primary"></i>
                            列表示管理
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-success">
                                    <i class="fas fa-check"></i> 表示中の列
                                </h6>
                                <div class="column-list" id="visibleColumnsList">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">
                                    <i class="fas fa-times"></i> 非表示の列
                                </h6>
                                <div class="column-list" id="hiddenColumnsList">
                                </div>
                                <div class="text-center mt-3" id="noHiddenColumns" style="display: none;">
                                    <span class="text-muted">
                                        <i class="fas fa-check-circle"></i>
                                        非表示の列はありません
                                    </span>
                                </div>
                            </div>
                        </div>

                        <hr class="my-3">

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="showAllColumns()">
                                <i class="fas fa-plus"></i> すべて表示
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetToDefault()">
                                <i class="fas fa-undo"></i> デフォルトに戻す
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" th:src="@{/js/historyReport.js}"></script>
</body>
</html>
