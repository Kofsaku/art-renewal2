<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <title>データモニター</title>
    <style>
        /* ---- ページ背景上書き ---- */
        .td-main {
            background: var(--td-header-bg);
        }

        /* ---- レイアウト ---- */
        .dm-outer {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 12px;
            box-sizing: border-box;
            background: var(--td-header-bg);
        }
        .dm-inner {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border: 2px solid var(--td-border);
            border-radius: 10px;
            overflow: hidden;
        }

        /* ---- ツールバー ---- */
        .dm-toolbar {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #f0f4f8;
            border-bottom: 1px solid var(--td-border);
            flex-wrap: wrap;
        }
        .dm-count {
            padding: 3px 10px;
            background: #fff;
            border: 2px solid #dc3545;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #dc3545;
            white-space: nowrap;
        }
        .dm-select-group {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
        }
        .dm-select {
            height: 28px;
            padding: 0 6px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.82rem;
            background: #fff;
            cursor: pointer;
        }
        .dm-data-type-group {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #333;
        }
        .dm-spacer { flex: 1; }
        .dm-btn {
            height: 28px;
            padding: 0 10px;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.15s;
        }
        .dm-btn:hover { background: #e9ecef; }

        /* ---- テーブルコンテナ ---- */
        .dm-table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
        }

        /* ---- テーブル ---- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            table-layout: auto;
        }
        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table th {
            background: #5a6268;
            color: #fff;
            font-weight: 600;
            padding: 6px 8px 6px 8px;
            border: 1px solid #495057;
            white-space: nowrap;
            position: relative;
            padding-right: 22px;
        }
        .data-table td {
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            white-space: nowrap;
        }
        .data-table tbody tr { background: #fff; }
        .data-table tbody tr.row-warning { background: #fff8e1; }
        .data-table tbody tr.row-error   { background: #fdecea; }
        .data-table tbody tr:hover { filter: brightness(0.96); }

        /* ステータスドット */
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            flex-shrink: 0;
        }
        .dot-normal  { background: #28a745; }
        .dot-warning { background: #e07b00; }
        .dot-error   { background: #dc3545; }
        .date-cell   { display: flex; align-items: center; }

        /* ---- フィルタートリガー ---- */
        .excel-filter-trigger {
            position: absolute;
            top: 50%; right: 4px;
            transform: translateY(-50%);
            width: 14px; height: 14px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .excel-filter-trigger::after {
            content: '▼';
            font-size: 9px;
            color: rgba(255,255,255,0.8);
        }
        .data-table th.filtered { background: #1565c0; }
        .data-table th.filtered .excel-filter-trigger::after { color: #fff; }

        /* ---- フッター凡例 ---- */
        .dm-legend {
            flex-shrink: 0;
            background: #f8f9fa;
            border-top: 1px solid var(--td-border);
            padding: 5px 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            font-size: 0.78rem;
            color: #555;
            flex-wrap: wrap;
        }
        .dm-legend-item {
            display: flex; align-items: center; gap: 4px;
        }

        /* ---- ヘッダー自動更新コントロール ---- */
        .dm-auto-update {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #212529;
        }
        .dm-start-btn {
            height: 28px;
            padding: 0 14px;
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
        }
        .dm-start-btn:hover { background: #218838; }
        .dm-start-btn.running { background: #dc3545; }
        .dm-start-btn.running:hover { background: #c82333; }
    </style>
</head>

<body>
    <!-- ヘッダー固有コントロール -->
    <div layout:fragment="header-controls" class="td-header-controls">
    </div>

    <!-- メインコンテンツ -->
    <div layout:fragment="content">
        <div class="dm-outer">
            <div class="dm-inner">
                <!-- ツールバー -->
                <div class="dm-toolbar">
                    <span class="dm-count">現条件: <span id="recordCount">0</span>件</span>

                    <div class="dm-select-group">
                        <span>表示件数:</span>
                        <select class="dm-select" id="pageSize">
                            <option value="50">50件</option>
                            <option value="100">100件</option>
                            <option value="200">200件</option>
                        </select>
                    </div>

                    <div class="dm-data-type-group">
                        <span>◆ データ種別:</span>
                        <select class="dm-select" id="dataType">
                            <option value="all">全データ表示</option>
                            <option value="normal">正常のみ</option>
                            <option value="warning">警告のみ</option>
                            <option value="error">異常のみ</option>
                        </select>
                    </div>

                    <div class="dm-spacer"></div>

                    <button class="dm-btn" id="filterReset">
                        <i class="fas fa-times-circle"></i>フィルターリセット
                    </button>
                    <button class="dm-btn" id="columnManager">
                        <i class="fas fa-columns"></i>列表示管理
                    </button>
                </div>

                <!-- テーブル -->
                <div class="dm-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-column="occurredDate">発生日付<div class="excel-filter-trigger"></div></th>
                                <th data-column="personalCode">個人コード<div class="excel-filter-trigger"></div></th>
                                <th data-column="name">氏名<div class="excel-filter-trigger"></div></th>
                                <th data-column="departmentCode">所属コード<div class="excel-filter-trigger"></div></th>
                                <th data-column="departmentName">所属名称<div class="excel-filter-trigger"></div></th>
                                <th data-column="gateNumber">ゲート番号<div class="excel-filter-trigger"></div></th>
                                <th data-column="gateName">ゲート名称<div class="excel-filter-trigger"></div></th>
                                <th data-column="historyDetails">履歴詳細<div class="excel-filter-trigger"></div></th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Thymeleafサーバーデータ -->
                            <tr th:each="data : ${historyDataList}" th:classappend="'row-' + ${data.statusClass}">
                                <td>
                                    <div class="date-cell">
                                        <span class="status-dot" th:classappend="'dot-' + ${data.statusClass}"></span>
                                        <span th:text="${data.occurredDate}">2026/01/27 09:44:50</span>
                                    </div>
                                </td>
                                <td th:text="${data.personalCode}"></td>
                                <td th:text="${data.name}"></td>
                                <td th:text="${data.departmentCode}"></td>
                                <td th:text="${data.departmentName}"></td>
                                <td th:text="${data.gateNumber}"></td>
                                <td th:text="${data.gateName}"></td>
                                <td th:text="${data.historyDetails}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <!-- 凡例（コピーライト直上） -->
    <div layout:fragment="page-legend">
        <div class="dm-legend">
            <div class="dm-legend-item">
                <span class="status-dot dot-normal"></span><span>正常</span>
            </div>
            <div class="dm-legend-item">
                <span class="status-dot dot-warning"></span><span>警告</span>
            </div>
            <div class="dm-legend-item">
                <span class="status-dot dot-error"></span><span>異常</span>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
    (function () {
        // デモデータ生成
        var demoData = [
            { type: 'normal',  date: '2026/01/27 09:44:50', code: '000680', name: '個人678', deptCode: '002', dept: '所属002', gate: '0004', gateName: 'XA0004',      detail: '退室' },
            { type: 'warning', date: '2026/01/27 09:44:47', code: '',       name: '',       deptCode: '',    dept: '',       gate: '0003', gateName: 'H=03 A=68',    detail: 'カードリーダー警告' },
            { type: 'normal',  date: '2026/01/27 09:44:44', code: '000341', name: '個人567', deptCode: '004', dept: '管理部', gate: '0003', gateName: 'XA0003',      detail: '入室' },
            { type: 'normal',  date: '2026/01/27 09:44:41', code: '000502', name: '個人888', deptCode: '003', dept: '所属003', gate: '0003', gateName: 'XA0003',     detail: '退室' },
            { type: 'warning', date: '2026/01/27 09:44:38', code: '',       name: '',       deptCode: '',    dept: '',       gate: '0003', gateName: 'H=03 A=42',    detail: '通信異常復旧' },
            { type: 'normal',  date: '2026/01/27 09:44:35', code: '000709', name: '個人724', deptCode: '001', dept: '所属001', gate: '0002', gateName: 'XA0002',     detail: '入室' },
            { type: 'normal',  date: '2026/01/27 09:44:32', code: '000982', name: '個人993', deptCode: '004', dept: '管理部', gate: '0003', gateName: 'XA0003',      detail: '入室' },
            { type: 'warning', date: '2026/01/27 09:44:29', code: '',       name: '',       deptCode: '',    dept: '',       gate: '0002', gateName: 'H=02 A=83',    detail: '通信異常復旧' },
            { type: 'normal',  date: '2026/01/27 09:44:26', code: '000601', name: '個人144', deptCode: '002', dept: '所属002', gate: '0002', gateName: 'XA0002',     detail: '退室' },
            { type: 'normal',  date: '2026/01/27 09:44:23', code: '000878', name: '個人446', deptCode: '002', dept: '所属002', gate: '0003', gateName: 'XA0003',     detail: '退室' },
            { type: 'normal',  date: '2026/01/27 09:44:20', code: '000994', name: '個人530', deptCode: '005', dept: '開発部', gate: '0003', gateName: 'XA0003',      detail: '退室' },
            { type: 'normal',  date: '2026/01/27 09:44:17', code: '000408', name: '個人744', deptCode: '005', dept: '開発部', gate: '0002', gateName: 'XA0002',      detail: '入室' },
            { type: 'normal',  date: '2026/01/27 09:44:14', code: '000872', name: '個人193', deptCode: '003', dept: '所属003', gate: '0001', gateName: 'XA0001',     detail: '退室' },
            { type: 'normal',  date: '2026/01/27 09:44:11', code: '000698', name: '個人363', deptCode: '004', dept: '管理部', gate: '0001', gateName: 'XA0001',      detail: '入室' },
            { type: 'normal',  date: '2026/01/27 09:44:08', code: '000681', name: '個人332', deptCode: '004', dept: '管理部', gate: '0001', gateName: 'XA0001',      detail: '退室' },
            { type: 'normal',  date: '2026/01/27 09:44:05', code: '000811', name: '個人085', deptCode: '001', dept: '所属001', gate: '0001', gateName: 'XA0001',     detail: '入室' },
            { type: 'error',   date: '2026/01/27 09:44:02', code: '',       name: '',       deptCode: '',    dept: '',       gate: '0001', gateName: 'H=01 A=99',    detail: 'ドア開放異常' },
            { type: 'error',   date: '2026/01/27 08:45:59', code: '',       name: '',       deptCode: '',    dept: '',       gate: '0002', gateName: 'H=02 A=4',     detail: '通信異常発生' },
        ];

        function renderTable(data) {
            var tbody = document.getElementById('dataTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            data.forEach(function (row) {
                var tr = document.createElement('tr');
                tr.className = row.type === 'warning' ? 'row-warning' : row.type === 'error' ? 'row-error' : '';
                tr.innerHTML =
                    '<td><div class="date-cell"><span class="status-dot dot-' + row.type + '"></span>' + row.date + '</div></td>' +
                    '<td>' + row.code + '</td>' +
                    '<td>' + row.name + '</td>' +
                    '<td>' + row.deptCode + '</td>' +
                    '<td>' + row.dept + '</td>' +
                    '<td>' + row.gate + '</td>' +
                    '<td>' + row.gateName + '</td>' +
                    '<td>' + row.detail + '</td>';
                tbody.appendChild(tr);
            });
            var el = document.getElementById('recordCount');
            if (el) el.textContent = data.length;
        }

        document.addEventListener('DOMContentLoaded', function () {
            renderTable(demoData);

            // データ種別フィルター
            var typeSelect = document.getElementById('dataType');
            if (typeSelect) {
                typeSelect.addEventListener('change', function () {
                    var v = this.value;
                    var filtered = v === 'all' ? demoData : demoData.filter(function (r) { return r.type === v; });
                    renderTable(filtered);
                });
            }

            // フィルターリセット
            var resetBtn = document.getElementById('filterReset');
            if (resetBtn) {
                resetBtn.addEventListener('click', function () {
                    if (typeSelect) typeSelect.value = 'all';
                    renderTable(demoData);
                });
            }

            // 自動更新：一時無効化
        });
    })();
    </script>
</body>
</html>
