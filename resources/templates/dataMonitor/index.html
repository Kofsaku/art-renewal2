<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <title>データモニター</title>
    <style>
        /* ---- ページ背景上書き ---- */
        .td-main {
            background: var(--td-header-bg);
        }

        /* ---- レイアウト ---- */
        .dm-outer {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 12px;
            box-sizing: border-box;
            background: var(--td-header-bg);
        }
        .dm-inner {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border: 2px solid var(--td-border);
            border-radius: 10px;
            overflow: hidden;
        }

        /* ---- ツールバー ---- */
        .dm-toolbar {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #f0f4f8;
            border-bottom: 1px solid var(--td-border);
            flex-wrap: wrap;
        }
        .dm-count {
            padding: 3px 10px;
            background: #fff;
            border: 2px solid #dc3545;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #dc3545;
            white-space: nowrap;
        }
        .dm-select-group {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
        }
        .dm-select {
            height: 28px;
            padding: 0 6px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.82rem;
            background: #fff;
            cursor: pointer;
        }
        .dm-data-type-group {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #333;
        }
        .dm-spacer { flex: 1; }
        .dm-btn {
            height: 28px;
            padding: 0 10px;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.15s;
        }
        .dm-btn:hover { background: #e9ecef; }

        /* ---- テーブルコンテナ ---- */
        .dm-table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
        }

        /* ---- テーブル ---- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            table-layout: auto;
        }
        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table th {
            background: #5a6268;
            color: #fff;
            font-weight: 600;
            padding: 6px 8px 6px 8px;
            border: 1px solid #495057;
            white-space: nowrap;
            position: relative;
            padding-right: 22px;
        }
        .data-table td {
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            white-space: nowrap;
        }
        .data-table tbody tr { background: #fff; }
        .data-table tbody tr.row-warning { background: #fff8e1; }
        .data-table tbody tr.row-error   { background: #fdecea; }
        .data-table tbody tr:hover { filter: brightness(0.96); }

        /* ステータスドット */
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            flex-shrink: 0;
        }
        .dot-normal  { background: #28a745; }
        .dot-warning { background: #e07b00; }
        .dot-error   { background: #dc3545; }
        .date-cell   { display: flex; align-items: center; }

        /* ---- Excelフィルター ---- */
        .excel-filter-trigger {
            position: absolute;
            top: 50%; right: 4px;
            transform: translateY(-50%);
            width: 16px; height: 16px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.5;
            transition: opacity 0.15s;
        }
        .excel-filter-trigger:hover { opacity: 1; }
        .excel-filter-trigger::after {
            content: '\f0b0';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 9px;
            color: rgba(255,255,255,0.8);
        }
        .excel-filter-trigger.active { opacity: 1; }
        .excel-filter-trigger.active::after {
            color: #ffc107;
        }
        .excel-filter-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 220px;
            max-width: 300px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            color: #333;
            font-weight: 400;
            font-size: 0.82rem;
        }
        .excel-filter-menu.show { display: block; }
        /* 右端列のオーバーフロー対策 */
        .data-table th:nth-last-child(-n+2) .excel-filter-menu {
            left: auto;
            right: 0;
        }
        .excel-filter-header {
            padding: 8px 10px 6px;
            font-weight: 600;
            font-size: 0.8rem;
            color: #555;
            border-bottom: 1px solid #eee;
        }
        .excel-search-section {
            padding: 6px 10px;
        }
        .excel-search-box {
            width: 100%;
            box-sizing: border-box;
            padding: 5px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.8rem;
            outline: none;
        }
        .excel-search-box:focus { border-color: #80bdff; }
        .excel-filter-actions {
            display: flex;
            gap: 4px;
            padding: 4px 10px 6px;
            border-bottom: 1px solid #eee;
        }
        .excel-action-btn {
            flex: 1;
            padding: 4px 0;
            background: #f0f4f8;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            text-align: center;
            transition: background 0.15s;
        }
        .excel-action-btn:hover { background: #e2e6ea; }
        .excel-action-btn.ok-btn {
            background: #007bff;
            color: #fff;
            border-color: #007bff;
        }
        .excel-action-btn.ok-btn:hover { background: #0069d9; }
        .excel-filter-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 4px 0;
        }
        .excel-filter-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            cursor: pointer;
            user-select: none;
            transition: background 0.1s;
        }
        .excel-filter-item:hover { background: #f0f4f8; }
        .excel-filter-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        .excel-filter-item label {
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ---- フッター凡例 ---- */
        .dm-legend {
            flex-shrink: 0;
            background: #f8f9fa;
            border-top: 1px solid var(--td-border);
            padding: 5px 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            font-size: 0.78rem;
            color: #555;
            flex-wrap: wrap;
        }
        .dm-legend-item {
            display: flex; align-items: center; gap: 4px;
        }

        /* ---- ヘッダー自動更新コントロール ---- */
        .dm-auto-update {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #212529;
        }
        .dm-start-btn {
            height: 28px;
            padding: 0 14px;
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
        }
        .dm-start-btn:hover { background: #218838; }
        .dm-start-btn.running { background: #dc3545; }
        .dm-start-btn.running:hover { background: #c82333; }
    </style>
</head>

<body>
    <!-- ヘッダー固有コントロール -->
    <div layout:fragment="header-controls" class="td-header-controls">
    </div>

    <!-- メインコンテンツ -->
    <div layout:fragment="content">
        <div class="dm-outer">
            <div class="dm-inner">
                <!-- ツールバー -->
                <div class="dm-toolbar">
                    <span class="dm-count">現条件: <span id="recordCount">0</span>件</span>

                    <div class="dm-select-group">
                        <span>表示件数:</span>
                        <select class="dm-select" id="pageSize">
                            <option value="50">50件</option>
                            <option value="100">100件</option>
                            <option value="200">200件</option>
                        </select>
                    </div>

                    <div class="dm-data-type-group">
                        <span>◆ データ種別:</span>
                        <select class="dm-select" id="dataType">
                            <option value="all">全データ表示</option>
                            <option value="normal">正常のみ</option>
                            <option value="warning">警告のみ</option>
                            <option value="error">異常のみ</option>
                        </select>
                    </div>

                    <div class="dm-spacer"></div>

                    <button class="dm-btn" id="filterReset">
                        <i class="fas fa-times-circle"></i>フィルターリセット
                    </button>
                    <button class="dm-btn" id="columnManager">
                        <i class="fas fa-columns"></i>列表示管理
                    </button>
                </div>

                <!-- テーブル -->
                <div class="dm-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-column="occurredDate">発生日付<div class="excel-filter-trigger" onclick="showDmFilter(event, 'occurredDate')"></div><div class="excel-filter-menu" id="excel-filter-occurredDate"></div></th>
                                <th data-column="personalCode">個人コード<div class="excel-filter-trigger" onclick="showDmFilter(event, 'personalCode')"></div><div class="excel-filter-menu" id="excel-filter-personalCode"></div></th>
                                <th data-column="name">氏名<div class="excel-filter-trigger" onclick="showDmFilter(event, 'name')"></div><div class="excel-filter-menu" id="excel-filter-name"></div></th>
                                <th data-column="departmentCode">所属コード<div class="excel-filter-trigger" onclick="showDmFilter(event, 'departmentCode')"></div><div class="excel-filter-menu" id="excel-filter-departmentCode"></div></th>
                                <th data-column="departmentName">所属名称<div class="excel-filter-trigger" onclick="showDmFilter(event, 'departmentName')"></div><div class="excel-filter-menu" id="excel-filter-departmentName"></div></th>
                                <th data-column="gateNumber">ゲート番号<div class="excel-filter-trigger" onclick="showDmFilter(event, 'gateNumber')"></div><div class="excel-filter-menu" id="excel-filter-gateNumber"></div></th>
                                <th data-column="gateName">ゲート名称<div class="excel-filter-trigger" onclick="showDmFilter(event, 'gateName')"></div><div class="excel-filter-menu" id="excel-filter-gateName"></div></th>
                                <th data-column="historyDetails">履歴詳細<div class="excel-filter-trigger" onclick="showDmFilter(event, 'historyDetails')"></div><div class="excel-filter-menu" id="excel-filter-historyDetails"></div></th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Thymeleafサーバーデータ -->
                            <tr th:each="data : ${historyDataList}" th:classappend="'row-' + ${data.statusClass}">
                                <td>
                                    <div class="date-cell">
                                        <span class="status-dot" th:classappend="'dot-' + ${data.statusClass}"></span>
                                        <span th:text="${data.occurredDate}">2026/01/27 09:44:50</span>
                                    </div>
                                </td>
                                <td th:text="${data.personalCode}"></td>
                                <td th:text="${data.name}"></td>
                                <td th:text="${data.departmentCode}"></td>
                                <td th:text="${data.departmentName}"></td>
                                <td th:text="${data.gateNumber}"></td>
                                <td th:text="${data.gateName}"></td>
                                <td th:text="${data.historyDetails}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <!-- 凡例（コピーライト直上） -->
    <div layout:fragment="page-legend">
        <div class="dm-legend">
            <div class="dm-legend-item">
                <span class="status-dot dot-normal"></span><span>正常</span>
            </div>
            <div class="dm-legend-item">
                <span class="status-dot dot-warning"></span><span>警告</span>
            </div>
            <div class="dm-legend-item">
                <span class="status-dot dot-error"></span><span>異常</span>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
    (function () {
        // data-column属性 → デモデータキーのマッピング
        var columnAttrToKey = {
            occurredDate: 'date',
            personalCode: 'code',
            name: 'name',
            departmentCode: 'deptCode',
            departmentName: 'dept',
            gateNumber: 'gate',
            gateName: 'gateName',
            historyDetails: 'detail'
        };
        var columnDisplayNames = {
            occurredDate: '発生日付',
            personalCode: '個人コード',
            name: '氏名',
            departmentCode: '所属コード',
            departmentName: '所属名称',
            gateNumber: 'ゲート番号',
            gateName: 'ゲート名称',
            historyDetails: '履歴詳細'
        };

        // Excelフィルター状態: { colAttr: Set of selected values } (未設定=全選択)
        var excelFilters = {};

        // デモデータ
        var demoData = [
            { type: 'normal',  date: '2026/01/27 09:44:50', code: '000680', name: '個人678', deptCode: '002', dept: '所属002', gate: '0004', gateName: 'XA0004',      detail: '退室' },
            { type: 'warning', date: '2026/01/27 09:44:47', code: '',       name: '',       deptCode: '',    dept: '',       gate: '0003', gateName: 'H=03 A=68',    detail: 'カードリーダー警告' },
            { type: 'normal',  date: '2026/01/27 09:44:44', code: '000341', name: '個人567', deptCode: '004', dept: '管理部', gate: '0003', gateName: 'XA0003',      detail: '入室' },
            { type: 'normal',  date: '2026/01/27 09:44:41', code: '000502', name: '個人888', deptCode: '003', dept: '所属003', gate: '0003', gateName: 'XA0003',     detail: '退室' },
            { type: 'warning', date: '2026/01/27 09:44:38', code: '',       name: '',       deptCode: '',    dept: '',       gate: '0003', gateName: 'H=03 A=42',    detail: '通信異常復旧' },
            { type: 'normal',  date: '2026/01/27 09:44:35', code: '000709', name: '個人724', deptCode: '001', dept: '所属001', gate: '0002', gateName: 'XA0002',     detail: '入室' },
            { type: 'normal',  date: '2026/01/27 09:44:32', code: '000982', name: '個人993', deptCode: '004', dept: '管理部', gate: '0003', gateName: 'XA0003',      detail: '入室' },
            { type: 'warning', date: '2026/01/27 09:44:29', code: '',       name: '',       deptCode: '',    dept: '',       gate: '0002', gateName: 'H=02 A=83',    detail: '通信異常復旧' },
            { type: 'normal',  date: '2026/01/27 09:44:26', code: '000601', name: '個人144', deptCode: '002', dept: '所属002', gate: '0002', gateName: 'XA0002',     detail: '退室' },
            { type: 'normal',  date: '2026/01/27 09:44:23', code: '000878', name: '個人446', deptCode: '002', dept: '所属002', gate: '0003', gateName: 'XA0003',     detail: '退室' },
            { type: 'normal',  date: '2026/01/27 09:44:20', code: '000994', name: '個人530', deptCode: '005', dept: '開発部', gate: '0003', gateName: 'XA0003',      detail: '退室' },
            { type: 'normal',  date: '2026/01/27 09:44:17', code: '000408', name: '個人744', deptCode: '005', dept: '開発部', gate: '0002', gateName: 'XA0002',      detail: '入室' },
            { type: 'normal',  date: '2026/01/27 09:44:14', code: '000872', name: '個人193', deptCode: '003', dept: '所属003', gate: '0001', gateName: 'XA0001',     detail: '退室' },
            { type: 'normal',  date: '2026/01/27 09:44:11', code: '000698', name: '個人363', deptCode: '004', dept: '管理部', gate: '0001', gateName: 'XA0001',      detail: '入室' },
            { type: 'normal',  date: '2026/01/27 09:44:08', code: '000681', name: '個人332', deptCode: '004', dept: '管理部', gate: '0001', gateName: 'XA0001',      detail: '退室' },
            { type: 'normal',  date: '2026/01/27 09:44:05', code: '000811', name: '個人085', deptCode: '001', dept: '所属001', gate: '0001', gateName: 'XA0001',     detail: '入室' },
            { type: 'error',   date: '2026/01/27 09:44:02', code: '',       name: '',       deptCode: '',    dept: '',       gate: '0001', gateName: 'H=01 A=99',    detail: 'ドア開放異常' },
            { type: 'error',   date: '2026/01/27 08:45:59', code: '',       name: '',       deptCode: '',    dept: '',       gate: '0002', gateName: 'H=02 A=4',     detail: '通信異常発生' },
        ];

        function escapeHtml(str) {
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        function renderTable(data) {
            var tbody = document.getElementById('dataTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            data.forEach(function (row) {
                var tr = document.createElement('tr');
                tr.className = row.type === 'warning' ? 'row-warning' : row.type === 'error' ? 'row-error' : '';
                tr.innerHTML =
                    '<td><div class="date-cell"><span class="status-dot dot-' + escapeHtml(row.type) + '"></span>' + escapeHtml(row.date) + '</div></td>' +
                    '<td>' + escapeHtml(row.code) + '</td>' +
                    '<td>' + escapeHtml(row.name) + '</td>' +
                    '<td>' + escapeHtml(row.deptCode) + '</td>' +
                    '<td>' + escapeHtml(row.dept) + '</td>' +
                    '<td>' + escapeHtml(row.gate) + '</td>' +
                    '<td>' + escapeHtml(row.gateName) + '</td>' +
                    '<td>' + escapeHtml(row.detail) + '</td>';
                tbody.appendChild(tr);
            });
            var el = document.getElementById('recordCount');
            if (el) el.textContent = data.length;
        }

        // ---- フィルターロジック ----

        // 他列フィルター＋データ種別を適用済みのデータからユニーク値を取得
        // excludeCol: 現在開いている列は除外して絞り込む
        function getFilteredBase(excludeCol) {
            var typeSelect = document.getElementById('dataType');
            var typeVal = typeSelect ? typeSelect.value : 'all';
            return demoData.filter(function (row) {
                if (typeVal !== 'all' && row.type !== typeVal) return false;
                for (var colAttr in excelFilters) {
                    if (colAttr === excludeCol) continue;
                    if (excelFilters.hasOwnProperty(colAttr)) {
                        var key = columnAttrToKey[colAttr];
                        var val = (row[key] || '').toString();
                        if (!excelFilters[colAttr].has(val)) return false;
                    }
                }
                return true;
            });
        }

        function getUniqueValues(colAttr) {
            var key = columnAttrToKey[colAttr];
            var baseData = getFilteredBase(colAttr);
            var seen = {};
            var values = [];
            baseData.forEach(function (row) {
                var v = (row[key] || '').toString();
                if (!seen[v]) { seen[v] = true; values.push(v); }
            });
            values.sort();
            return values;
        }

        function hideDmFilters() {
            document.querySelectorAll('.excel-filter-menu.show').forEach(function (m) {
                m.classList.remove('show');
            });
        }

        function showDmFilter(event, colAttr) {
            event.stopPropagation();
            var menuId = 'excel-filter-' + colAttr;
            var menu = document.getElementById(menuId);
            if (!menu) return;

            var wasOpen = menu.classList.contains('show');
            hideDmFilters();
            if (wasOpen) return;

            var allValues = getUniqueValues(colAttr);
            var selected = excelFilters[colAttr] || null; // null = 全選択

            var html = '';
            html += '<div class="excel-filter-header">' + escapeHtml(columnDisplayNames[colAttr] || colAttr) + ' のフィルター</div>';
            html += '<div class="excel-search-section"><input type="text" class="excel-search-box" placeholder="検索..." oninput="filterDmOptions(\'' + colAttr + '\', this.value)"></div>';
            html += '<div class="excel-filter-actions">';
            html += '<button class="excel-action-btn" onclick="selectAllDmFilter(\'' + colAttr + '\')">すべて選択</button>';
            html += '<button class="excel-action-btn" onclick="clearAllDmFilter(\'' + colAttr + '\')">すべてクリア</button>';
            html += '<button class="excel-action-btn ok-btn" onclick="applyDmFilter(\'' + colAttr + '\')">OK</button>';
            html += '</div>';
            html += '<div class="excel-filter-list" id="excel-list-' + colAttr + '">';
            allValues.forEach(function (val) {
                var checked = !selected || selected.has(val) ? 'checked' : '';
                var displayVal = val === '' ? '(空白)' : escapeHtml(val);
                html += '<div class="excel-filter-item" data-value="' + escapeHtml(val) + '" onclick="toggleDmOption(event, this)">';
                html += '<input type="checkbox" ' + checked + '>';
                html += '<label>' + displayVal + '</label>';
                html += '</div>';
            });
            html += '</div>';

            menu.innerHTML = html;
            menu.classList.add('show');
        }

        function toggleDmOption(e, itemEl) {
            // チェックボックス直接クリック時はネイティブ動作に任せる
            if (e.target.tagName === 'INPUT') return;
            var cb = itemEl.querySelector('input[type="checkbox"]');
            if (cb) cb.checked = !cb.checked;
        }

        function selectAllDmFilter(colAttr) {
            var list = document.getElementById('excel-list-' + colAttr);
            if (!list) return;
            list.querySelectorAll('.excel-filter-item').forEach(function (item) {
                if (item.style.display !== 'none') {
                    var cb = item.querySelector('input[type="checkbox"]');
                    if (cb) cb.checked = true;
                }
            });
        }

        function clearAllDmFilter(colAttr) {
            var list = document.getElementById('excel-list-' + colAttr);
            if (!list) return;
            list.querySelectorAll('.excel-filter-item').forEach(function (item) {
                if (item.style.display !== 'none') {
                    var cb = item.querySelector('input[type="checkbox"]');
                    if (cb) cb.checked = false;
                }
            });
        }

        function filterDmOptions(colAttr, searchText) {
            var list = document.getElementById('excel-list-' + colAttr);
            if (!list) return;
            var lower = searchText.toLowerCase();
            list.querySelectorAll('.excel-filter-item').forEach(function (item) {
                var val = (item.getAttribute('data-value') || '').toLowerCase();
                var display = val === '' ? '(空白)' : val;
                item.style.display = (lower === '' || display.indexOf(lower) >= 0) ? '' : 'none';
            });
        }

        function applyDmFilter(colAttr) {
            var list = document.getElementById('excel-list-' + colAttr);
            if (!list) return;

            var allValues = getUniqueValues(colAttr);
            var selectedSet = new Set();
            list.querySelectorAll('.excel-filter-item').forEach(function (item) {
                var cb = item.querySelector('input[type="checkbox"]');
                if (cb && cb.checked) {
                    selectedSet.add(item.getAttribute('data-value'));
                }
            });

            // 全て選択されている場合はフィルター解除
            if (selectedSet.size === allValues.length) {
                delete excelFilters[colAttr];
            } else {
                excelFilters[colAttr] = selectedSet;
            }

            hideDmFilters();
            applyAllFilters();
            updateFilterTriggerStates();
        }

        function applyAllFilters() {
            var typeSelect = document.getElementById('dataType');
            var typeVal = typeSelect ? typeSelect.value : 'all';

            var filtered = demoData.filter(function (row) {
                // データ種別フィルター
                if (typeVal !== 'all' && row.type !== typeVal) return false;
                // Excelカラムフィルター
                for (var colAttr in excelFilters) {
                    if (excelFilters.hasOwnProperty(colAttr)) {
                        var key = columnAttrToKey[colAttr];
                        var val = (row[key] || '').toString();
                        if (!excelFilters[colAttr].has(val)) return false;
                    }
                }
                return true;
            });

            renderTable(filtered);
        }

        function updateFilterTriggerStates() {
            document.querySelectorAll('.excel-filter-trigger').forEach(function (trigger) {
                var th = trigger.closest('th');
                if (!th) return;
                var colAttr = th.getAttribute('data-column');
                if (excelFilters[colAttr]) {
                    trigger.classList.add('active');
                } else {
                    trigger.classList.remove('active');
                }
            });
        }

        // グローバル公開（onclick用）
        window.showDmFilter = showDmFilter;
        window.hideDmFilters = hideDmFilters;
        window.toggleDmOption = toggleDmOption;
        window.selectAllDmFilter = selectAllDmFilter;
        window.clearAllDmFilter = clearAllDmFilter;
        window.filterDmOptions = filterDmOptions;
        window.applyDmFilter = applyDmFilter;

        document.addEventListener('DOMContentLoaded', function () {
            renderTable(demoData);

            // データ種別フィルター
            var typeSelect = document.getElementById('dataType');
            if (typeSelect) {
                typeSelect.addEventListener('change', function () {
                    applyAllFilters();
                });
            }

            // フィルターリセット
            var resetBtn = document.getElementById('filterReset');
            if (resetBtn) {
                resetBtn.addEventListener('click', function () {
                    if (typeSelect) typeSelect.value = 'all';
                    excelFilters = {};
                    updateFilterTriggerStates();
                    applyAllFilters();
                });
            }

            // 外側クリックでフィルターメニューを閉じる
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.excel-filter-menu') && !e.target.closest('.excel-filter-trigger')) {
                    hideDmFilters();
                }
            });
        });
    })();
    </script>
</body>
</html>
